<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teclado Musical - PEMSAM</title>
  <style>
    :root{ --azul:#03658C; --amarillo:#F2B705; --rojo:#F20505; --verde:#2ecc71; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif; background:#f7fbff; color:#024}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .panel{background:#fff;border:2px solid var(--azul);border-radius:12px;padding:14px;box-shadow:0 10px 22px rgba(6,9,102,0.08)}
    h1{margin:0 0 8px;font-size:1.25rem;color:var(--azul)}
    .scoreboard{font-weight:700;color:#024;margin-bottom:8px}
    .controls{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .btn{background:var(--azul);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:hover{background:var(--amarillo);color:var(--azul)}

    #keyboard{display:flex;justify-content:center;gap:6px;margin:12px auto}
    .key{width:60px;height:150px;margin:0 3px;border:1px solid #333;border-radius:0 0 8px 8px;display:flex;justify-content:center;align-items:flex-end;padding-bottom:10px;user-select:none;cursor:pointer;transition:transform .06s ease}
    .key.white{background:#fff;color:#000}
    .key.black{background:#000;color:#fff}
    .key.active{transform:translateY(2px); box-shadow:inset 0 0 8px rgba(0,0,0,.3)}

    #melody{font-weight:700;color:#03658C;margin-top:8px;text-align:center}
    #instructions{margin:8px 0;color:#03658C}
    #message{margin-top:8px;font-weight:700;min-height:20px}
    #message.ok{color:var(--verde)}
    #message.err{color:var(--rojo)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>Teclado Musical</h1>
      <div class="scoreboard">Melodías correctas: <span id="correct">0</span></div>
      <div id="instructions">Presiona las teclas C D E F G A B en el orden de la melodía. También puedes hacer clic en las teclas.</div>
      <div id="keyboard" aria-label="Teclado musical"></div>
      <div id="melody"></div>
      <div id="message" aria-live="polite"></div>
      <div class="controls">
        <button id="new" class="btn">Nueva melodía</button>
        <button id="restart" class="btn">Reiniciar</button>
        <div class="labs" style="display:flex; gap:6px; align-items:center;">
          <span style="font-weight:700;color:#024">Labs:</span>
          <button class="btn lab-btn" data-lab="0">Lab 1</button>
          <button class="btn lab-btn" data-lab="1">Lab 2</button>
          <button class="btn lab-btn" data-lab="2">Lab 3</button>
          <button class="btn lab-btn" data-lab="3">Lab 4</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const notes = ['C','D','E','F','G','A','B'];
      const keys  = ['c','d','e','f','g','a','b'];
      const freq = { C:261.63, D:293.66, E:329.63, F:349.23, G:392.00, A:440.00, B:493.88 };

      const keyboardEl = document.getElementById('keyboard');
      const melodyEl = document.getElementById('melody');
      const correctEl = document.getElementById('correct');
      const msgEl = document.getElementById('message');
      const newBtn = document.getElementById('new');
      const restartBtn = document.getElementById('restart');

      // Labs predefinidos (4 labs)
      const labs = [
        ['C','D','E','F','G'],
        ['E','D','C','D','E','E','E'],
        ['C','C','G','G','A','A','G'],
        ['E','E','F','G','G','F','E','D','C']
      ];
      let activeLab = null; // índice del lab seleccionado o null para modo aleatorio

      let audioCtx = null;
      function playNote(n){
        try{
          if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'sine';
          osc.frequency.value = freq[n] || 440;
          gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
          gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.45);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.5);
        }catch(e){ /* noop */ }
      }

      let correctMelodies = 0;
      let currentMelody = [];
      let userMelody = [];

      function setMessage(text, ok){
        msgEl.textContent = text || '';
        msgEl.className = ok == null ? '' : (ok ? 'ok' : 'err');
        if (msgEl.className) msgEl.className = ' ' + msgEl.className + ' message';
        msgEl.id = 'message';
      }

      function generateMelody(){
        currentMelody = [];
        if (activeLab != null && labs[activeLab]) {
          currentMelody = labs[activeLab].slice();
          melodyEl.textContent = currentMelody.join(' - ') + ` (Lab ${activeLab+1})`;
        } else {
          const len = 5; // longitud de la melodía
          for(let i=0;i<len;i++){
            currentMelody.push(notes[Math.floor(Math.random()*notes.length)]);
          }
          melodyEl.textContent = currentMelody.join(' - ');
        }
        userMelody = [];
        setMessage('', null);
      }

      function highlightKey(note){
        const el = keyboardEl.querySelector(`.key[data-note="${note}"]`);
        if(!el) return;
        el.classList.add('active');
        setTimeout(()=> el.classList.remove('active'), 150);
      }

      function pressNote(note){
        highlightKey(note);
        playNote(note);
        userMelody.push(note);
        // Validación incremental
        for(let i=0;i<userMelody.length;i++){
          if(userMelody[i] !== currentMelody[i]){
            setMessage('¡Melodía incorrecta! Intenta de nuevo.', false);
            userMelody = [];
            return;
          }
        }
        setMessage('', null);
        if (userMelody.length === currentMelody.length){
          correctMelodies++;
          correctEl.textContent = String(correctMelodies);
          const completedMsg = (activeLab != null) ? `¡Bien! Lab ${activeLab+1} completo.` : '¡Bien! Melodía correcta.';
          setMessage(completedMsg, true);
          generateMelody();
        }
      }

      function onKeyDown(e){
        const k = e.key.toLowerCase();
        const idx = keys.indexOf(k);
        if(idx !== -1){ pressNote(notes[idx]); }
      }

      function buildKeyboard(){
        keyboardEl.innerHTML = '';
        notes.forEach((n, i)=>{
          const key = document.createElement('div');
          key.className = 'key ' + (i % 2 === 0 ? 'white' : 'black');
          key.textContent = n;
          key.dataset.note = n;
          key.title = `Tecla ${n} (${keys[i].toUpperCase()})`;
          key.addEventListener('mousedown', ()=> pressNote(n));
          keyboardEl.appendChild(key);
        });
      }

      function restart(){
        correctMelodies = 0; correctEl.textContent = '0';
        generateMelody();
        setMessage('Presiona las teclas en el orden de la melodía.', null);
      }

      function selectLab(index){
        if (isNaN(index) || index < 0 || index >= labs.length) {
          activeLab = null;
          setMessage('Modo aleatorio activado.', null);
        } else {
          activeLab = index;
          setMessage(`Lab ${index+1} seleccionado.`, null);
        }
        generateMelody();
      }

      // Init
      buildKeyboard();
      generateMelody();
      setMessage('Presiona las teclas en el orden de la melodía.', null);

      // Events
      document.addEventListener('keydown', onKeyDown);
      newBtn.addEventListener('click', ()=> { activeLab = null; generateMelody(); });
      restartBtn.addEventListener('click', restart);
      document.querySelectorAll('.lab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=> {
          const i = parseInt(btn.dataset.lab, 10);
          selectLab(i);
        });
      });
      window.addEventListener('beforeunload', ()=> document.removeEventListener('keydown', onKeyDown));
    })();
  </script>
</body>
</html>
