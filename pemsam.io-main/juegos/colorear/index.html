<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Colorear - PEMSAM</title>
  <style>
    :root {
      --azul: #069;
      --amarillo: #fc0;
      --verde: #393;
      --negro: #1d1d1b;
      --blanco: #fff;
      --gris: #f3f5f8;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; overflow:hidden; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--gris);
      color: var(--negro);
      display: flex;
      min-height: 100vh;
    }
    .app {
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px;
    }
    .app header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: #fff;
      border: 2px solid var(--azul);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--azul);
      font-weight: 800;
      letter-spacing: .3px;
    }
    .title .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--amarillo); border: 2px solid var(--azul); }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 10px;
      align-items: center;
    }
    .palette { display: flex; flex-wrap: wrap; gap: 6px; }
    .color-btn {
      width: 28px; height: 28px; border-radius: 6px; border: 2px solid #0002; cursor: pointer; outline: none;
    }
    .color-btn[aria-pressed="true"] { outline: 3px solid var(--azul); outline-offset: 2px; }
    .tool-btn {
      border: 2px solid var(--azul);
      color: var(--azul);
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .tool-btn:hover { background: var(--amarillo); color: var(--azul); }
    .tool-btn.secondary { border-color: #0002; color: #253; }

    .board {
      background: #fff;
      border: 2px solid var(--azul);
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(0,0,0,.08);
      padding: 10px;
      overflow: auto;
    }
    svg { max-width: 100%; height: auto; display: block; margin: 0 auto; }
    .paintable { cursor: pointer; transition: opacity .15s ease; }
    .paintable:hover { opacity: .9; }

    .footer {
      display: flex; justify-content: space-between; align-items: center; gap: 8px; padding: 6px 10px; color: #345; font-size: .95rem;
    }
    .footer small { opacity: .8; }

    @media (max-width: 800px) {
      .toolbar { gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Juego de colorear">
    <header>
      <div class="title"><span class="dot"></span> Colorear</div>
      <div class="toolbar" aria-label="Herramientas de coloreo">
        <div class="palette" role="group" aria-label="Paleta de colores">
          <button class="color-btn" data-color="#ffffff" title="Blanco" style="background:#ffffff"></button>
          <button class="color-btn" data-color="#000000" title="Negro" style="background:#000000"></button>
          <button class="color-btn" data-color="#ff3b30" title="Rojo" style="background:#ff3b30"></button>
          <button class="color-btn" data-color="#ff9f0a" title="Naranja" style="background:#ff9f0a"></button>
          <button class="color-btn" data-color="#ffd60a" title="Amarillo" style="background:#ffd60a"></button>
          <button class="color-btn" data-color="#34c759" title="Verde" style="background:#34c759"></button>
          <button class="color-btn" data-color="#0a84ff" title="Azul" style="background:#0a84ff"></button>
          <button class="color-btn" data-color="#5e5ce6" title="Violeta" style="background:#5e5ce6"></button>
          <button class="color-btn" data-color="#ff2d55" title="Rosa" style="background:#ff2d55"></button>
          <button class="color-btn" data-color="#8e735b" title="Café" style="background:#8e735b"></button>
        </div>
        <input id="custom-color" type="color" title="Color personalizado" value="#ff9f0a" style="width:34px;height:34px;border:none;background:transparent;" />
        <select id="tpl-select" class="tool-btn" title="Elegir imagen">
          <option value="casa">Casa</option>
          <option value="mariposa">Mariposa</option>
          <option value="flor">Flor</option>
          <option value="coche">Coche</option>
          <option value="pez">Pez</option>
          <option value="dinosaurio">Dinosaurio</option>
          <option value="robot">Robot</option>
          <option value="castillo">Castillo</option>
        </select>
        <button id="eraser" class="tool-btn secondary" title="Borrador (blanco)">Borrar</button>
        <button id="undo" class="tool-btn" title="Deshacer (Ctrl+Z)">Deshacer</button>
        <button id="redo" class="tool-btn" title="Rehacer (Ctrl+Y)">Rehacer</button>
        <button id="clear" class="tool-btn" title="Limpiar todo">Limpiar</button>
        <button id="save" class="tool-btn" title="Guardar como PNG">Guardar PNG</button>
      </div>
    </header>

    <div id="board" class="board" aria-live="polite">
      <!-- Escena SVG: casa, árbol, sol, cielo y pasto -->
      <svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Lámina para colorear">
        <defs>
          <style>
            .line { stroke: #000; stroke-width: 3; }
          </style>
        </defs>
        <!-- Cielo y pasto -->
        <rect id="sky" class="paintable line" x="0" y="0" width="800" height="350" fill="#ffffff" />
        <rect id="grass" class="paintable line" x="0" y="350" width="800" height="150" fill="#ffffff" />

        <!-- Sol -->
        <g id="sun" class="line">
          <circle id="sun-core" class="paintable" cx="700" cy="90" r="38" fill="#ffffff" />
          <g id="sun-rays">
            <line x1="700" y1="30" x2="700" y2="0" />
            <line x1="700" y1="150" x2="700" y2="180" />
            <line x1="640" y1="90" x2="610" y2="90" />
            <line x1="760" y1="90" x2="790" y2="90" />
            <line x1="660" y1="50" x2="640" y2="30" />
            <line x1="740" y1="130" x2="760" y2="150" />
            <line x1="660" y1="130" x2="640" y2="150" />
            <line x1="740" y1="50" x2="760" y2="30" />
          </g>
        </g>

        <!-- Casa -->
        <g id="house">
          <!-- Cuerpo -->
          <rect id="house-body" class="paintable line" x="220" y="220" width="220" height="160" fill="#ffffff" />
          <!-- Techo -->
          <polygon id="house-roof" class="paintable line" points="210,220 330,140 450,220" fill="#ffffff" />
          <!-- Puerta -->
          <rect id="house-door" class="paintable line" x="315" y="300" width="40" height="80" fill="#ffffff" />
          <circle id="house-knob" class="paintable line" cx="349" cy="340" r="5" fill="#ffffff" />
          <!-- Ventanas -->
          <rect id="house-window1" class="paintable line" x="245" y="250" width="48" height="48" fill="#ffffff" />
          <line class="line" x1="245" y1="274" x2="293" y2="274" />
          <line class="line" x1="269" y1="250" x2="269" y2="298" />
          <rect id="house-window2" class="paintable line" x="367" y="250" width="48" height="48" fill="#ffffff" />
          <line class="line" x1="367" y1="274" x2="415" y2="274" />
          <line class="line" x1="391" y1="250" x2="391" y2="298" />
        </g>

        <!-- Árbol -->
        <g id="tree">
          <rect id="tree-trunk" class="paintable line" x="540" y="290" width="28" height="90" fill="#ffffff" />
          <circle id="tree-top1" class="paintable line" cx="554" cy="270" r="42" fill="#ffffff" />
          <circle id="tree-top2" class="paintable line" cx="590" cy="280" r="36" fill="#ffffff" />
          <circle id="tree-top3" class="paintable line" cx="520" cy="285" r="36" fill="#ffffff" />
        </g>

        <!-- Camino -->
        <path id="path" class="paintable line" d="M 0 430 C 120 420, 220 460, 340 450 C 470 438, 600 420, 800 440 L 800 500 L 0 500 Z" fill="#ffffff" />

        <!-- Nubes -->
        <g id="cloud1" class="line">
          <ellipse id="cloud1-a" class="paintable" cx="140" cy="90" rx="40" ry="24" fill="#ffffff" />
          <ellipse id="cloud1-b" class="paintable" cx="180" cy="85" rx="36" ry="22" fill="#ffffff" />
          <ellipse id="cloud1-c" class="paintable" cx="110" cy="100" rx="28" ry="18" fill="#ffffff" />
        </g>
        <g id="cloud2" class="line">
          <ellipse id="cloud2-a" class="paintable" cx="330" cy="80" rx="30" ry="18" fill="#ffffff" />
          <ellipse id="cloud2-b" class="paintable" cx="360" cy="76" rx="24" ry="16" fill="#ffffff" />
          <ellipse id="cloud2-c" class="paintable" cx="300" cy="90" rx="22" ry="14" fill="#ffffff" />
        </g>
      </svg>
    </div>

    <div class="footer">
      <small>Consejo: elige un color y toca una zona para pintarla. Usa Deshacer si te equivocas.</small>
      <small>PEMSAM</small>
    </div>
  </div>

  <script>
    (function(){
      let sheet = document.getElementById('sheet');
      const board = document.getElementById('board');
      const tplSelect = document.getElementById('tpl-select');
      const paletteButtons = Array.from(document.querySelectorAll('.color-btn'));
      const customColor = document.getElementById('custom-color');
      const eraserBtn = document.getElementById('eraser');
      const undoBtn = document.getElementById('undo');
      const redoBtn = document.getElementById('redo');
      const clearBtn = document.getElementById('clear');
      const saveBtn = document.getElementById('save');

      let currentColor = paletteButtons[3]?.dataset.color || '#ff9f0a';
      let history = []; // {type:'paint', id, prev, next}
      let future = [];

      // Plantillas de imágenes para colorear
      const templates = {
        casa: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Lámina para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; }
    </style>
  </defs>
  <rect id="sky" class="paintable line" x="0" y="0" width="800" height="350" fill="#ffffff" />
  <rect id="grass" class="paintable line" x="0" y="350" width="800" height="150" fill="#ffffff" />
  <g id="sun" class="line">
    <circle id="sun-core" class="paintable" cx="700" cy="90" r="38" fill="#ffffff" />
    <g id="sun-rays">
      <line x1="700" y1="30" x2="700" y2="0" />
      <line x1="700" y1="150" x2="700" y2="180" />
      <line x1="640" y1="90" x2="610" y2="90" />
      <line x1="760" y1="90" x2="790" y2="90" />
      <line x1="660" y1="50" x2="640" y2="30" />
      <line x1="740" y1="130" x2="760" y2="150" />
      <line x1="660" y1="130" x2="640" y2="150" />
      <line x1="740" y1="50" x2="760" y2="30" />
    </g>
  </g>
  <g id="house">
    <rect id="house-body" class="paintable line" x="220" y="220" width="220" height="160" fill="#ffffff" />
    <polygon id="house-roof" class="paintable line" points="210,220 330,140 450,220" fill="#ffffff" />
    <rect id="house-door" class="paintable line" x="315" y="300" width="40" height="80" fill="#ffffff" />
    <circle id="house-knob" class="paintable line" cx="349" cy="340" r="5" fill="#ffffff" />
    <rect id="house-window1" class="paintable line" x="245" y="250" width="48" height="48" fill="#ffffff" />
    <line class="line" x1="245" y1="274" x2="293" y2="274" />
    <line class="line" x1="269" y1="250" x2="269" y2="298" />
    <rect id="house-window2" class="paintable line" x="367" y="250" width="48" height="48" fill="#ffffff" />
    <line class="line" x1="367" y1="274" x2="415" y2="274" />
    <line class="line" x1="391" y1="250" x2="391" y2="298" />
  </g>
  <g id="tree">
    <rect id="tree-trunk" class="paintable line" x="540" y="290" width="28" height="90" fill="#ffffff" />
    <circle id="tree-top1" class="paintable line" cx="554" cy="270" r="42" fill="#ffffff" />
    <circle id="tree-top2" class="paintable line" cx="590" cy="280" r="36" fill="#ffffff" />
    <circle id="tree-top3" class="paintable line" cx="520" cy="285" r="36" fill="#ffffff" />
  </g>
  <path id="path" class="paintable line" d="M 0 430 C 120 420, 220 460, 340 450 C 470 438, 600 420, 800 440 L 800 500 L 0 500 Z" fill="#ffffff" />
  <g id="cloud1" class="line">
    <ellipse id="cloud1-a" class="paintable" cx="140" cy="90" rx="40" ry="24" fill="#ffffff" />
    <ellipse id="cloud1-b" class="paintable" cx="180" cy="85" rx="36" ry="22" fill="#ffffff" />
    <ellipse id="cloud1-c" class="paintable" cx="110" cy="100" rx="28" ry="18" fill="#ffffff" />
  </g>
  <g id="cloud2" class="line">
    <ellipse id="cloud2-a" class="paintable" cx="330" cy="80" rx="30" ry="18" fill="#ffffff" />
    <ellipse id="cloud2-b" class="paintable" cx="360" cy="76" rx="24" ry="16" fill="#ffffff" />
    <ellipse id="cloud2-c" class="paintable" cx="300" cy="90" rx="22" ry="14" fill="#ffffff" />
  </g>
</svg>
        `,
        mariposa: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Mariposa para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; fill: none; }
    </style>
  </defs>
  <!-- cuerpo -->
  <ellipse id="bf-body" class="paintable line" cx="400" cy="250" rx="18" ry="70" fill="#ffffff" />
  <circle id="bf-head" class="paintable line" cx="400" cy="165" r="24" fill="#ffffff" />
  <line class="line" x1="390" y1="140" x2="360" y2="110" />
  <line class="line" x1="410" y1="140" x2="440" y2="110" />
  <circle id="bf-antennaL" class="paintable line" cx="355" cy="105" r="6" fill="#ffffff" />
  <circle id="bf-antennaR" class="paintable line" cx="445" cy="105" r="6" fill="#ffffff" />
  <!-- alas -->
  <path id="bf-wingLT" class="paintable line" d="M380,210 C300,140 260,220 300,270 C340,320 360,300 380,260 Z" fill="#ffffff" />
  <path id="bf-wingLB" class="paintable line" d="M380,290 C330,320 300,360 340,380 C380,400 380,350 380,320 Z" fill="#ffffff" />
  <path id="bf-wingRT" class="paintable line" d="M420,210 C500,140 540,220 500,270 C460,320 440,300 420,260 Z" fill="#ffffff" />
  <path id="bf-wingRB" class="paintable line" d="M420,290 C470,320 500,360 460,380 C420,400 420,350 420,320 Z" fill="#ffffff" />
  <!-- decoraciones -->
  <circle id="bf-deco1" class="paintable line" cx="340" cy="255" r="16" fill="#ffffff" />
  <circle id="bf-deco2" class="paintable line" cx="460" cy="255" r="16" fill="#ffffff" />
  <circle id="bf-deco3" class="paintable line" cx="350" cy="325" r="12" fill="#ffffff" />
  <circle id="bf-deco4" class="paintable line" cx="450" cy="325" r="12" fill="#ffffff" />
</svg>
        `,
        flor: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Flor para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; }
    </style>
  </defs>
  <rect id="flor-bg" class="paintable line" x="0" y="0" width="800" height="500" fill="#ffffff" />
  <circle id="flor-center" class="paintable line" cx="400" cy="220" r="28" fill="#ffffff" />
  <circle id="flor-p1" class="paintable line" cx="400" cy="160" r="36" fill="#ffffff" />
  <circle id="flor-p2" class="paintable line" cx="340" cy="200" r="36" fill="#ffffff" />
  <circle id="flor-p3" class="paintable line" cx="460" cy="200" r="36" fill="#ffffff" />
  <circle id="flor-p4" class="paintable line" cx="360" cy="260" r="36" fill="#ffffff" />
  <circle id="flor-p5" class="paintable line" cx="440" cy="260" r="36" fill="#ffffff" />
  <rect id="flor-stem" class="paintable line" x="392" y="248" width="16" height="160" fill="#ffffff" />
  <ellipse id="flor-leafL" class="paintable line" cx="360" cy="320" rx="34" ry="18" fill="#ffffff" />
  <ellipse id="flor-leafR" class="paintable line" cx="440" cy="340" rx="34" ry="18" fill="#ffffff" />
</svg>
        `,
        coche: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Coche para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; }
    </style>
  </defs>
  <rect id="car-bg" class="paintable line" x="0" y="0" width="800" height="500" fill="#ffffff" />
  <rect id="car-body" class="paintable line" x="220" y="260" width="360" height="80" rx="18" fill="#ffffff" />
  <polygon id="car-top" class="paintable line" points="270,260 370,200 520,200 560,260" fill="#ffffff" />
  <rect id="car-window1" class="paintable line" x="380" y="210" width="60" height="40" fill="#ffffff" />
  <rect id="car-window2" class="paintable line" x="450" y="210" width="60" height="40" fill="#ffffff" />
  <circle id="car-wheelL" class="paintable line" cx="300" cy="350" r="34" fill="#ffffff" />
  <circle id="car-wheelR" class="paintable line" cx="520" cy="350" r="34" fill="#ffffff" />
  <circle id="car-hubL" class="paintable line" cx="300" cy="350" r="16" fill="#ffffff" />
  <circle id="car-hubR" class="paintable line" cx="520" cy="350" r="16" fill="#ffffff" />
  <rect id="car-lightF" class="paintable line" x="570" y="290" width="18" height="16" rx="4" fill="#ffffff" />
  <rect id="car-lightB" class="paintable line" x="230" y="290" width="18" height="16" rx="4" fill="#ffffff" />
</svg>
        `,
        pez: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Pez para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; }
    </style>
  </defs>
  <rect id="sea-bg" class="paintable line" x="0" y="0" width="800" height="500" fill="#ffffff" />
  <ellipse id="fish-body" class="paintable line" cx="400" cy="260" rx="120" ry="70" fill="#ffffff" />
  <polygon id="fish-tail" class="paintable line" points="500,220 560,260 500,300" fill="#ffffff" />
  <polygon id="fish-fin" class="paintable line" points="380,220 420,200 400,240" fill="#ffffff" />
  <circle id="fish-eye" class="paintable line" cx="350" cy="250" r="10" fill="#ffffff" />
  <circle id="bubble1" class="paintable line" cx="300" cy="160" r="10" fill="#ffffff" />
  <circle id="bubble2" class="paintable line" cx="280" cy="130" r="7" fill="#ffffff" />
  <circle id="bubble3" class="paintable line" cx="260" cy="105" r="5" fill="#ffffff" />
</svg>
        `,
        dinosaurio: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Dinosaurio para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; }
    </style>
  </defs>
  <!-- cuerpo y cabeza -->
  <ellipse id="dino-body" class="paintable line" cx="420" cy="300" rx="180" ry="90" fill="#ffffff" />
  <circle id="dino-head" class="paintable line" cx="570" cy="230" r="50" fill="#ffffff" />
  <!-- ojo -->
  <circle id="dino-eye" class="paintable line" cx="585" cy="220" r="8" fill="#ffffff" />
  <!-- cola -->
  <polygon id="dino-tail" class="paintable line" points="240,310 170,280 240,350" fill="#ffffff" />
  <!-- patas -->
  <rect id="dino-leg1" class="paintable line" x="380" y="360" width="28" height="60" fill="#ffffff" />
  <rect id="dino-leg2" class="paintable line" x="460" y="360" width="28" height="60" fill="#ffffff" />
  <!-- placas -->
  <circle id="dino-plate1" class="paintable line" cx="500" cy="190" r="16" fill="#ffffff" />
  <circle id="dino-plate2" class="paintable line" cx="460" cy="170" r="16" fill="#ffffff" />
  <circle id="dino-plate3" class="paintable line" cx="420" cy="160" r="16" fill="#ffffff" />
  <circle id="dino-plate4" class="paintable line" cx="380" cy="170" r="16" fill="#ffffff" />
</svg>
        `,
        robot: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Robot para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; }
    </style>
  </defs>
  <!-- cabeza -->
  <rect id="robot-head" class="paintable line" x="340" y="120" width="120" height="90" rx="10" fill="#ffffff" />
  <rect id="robot-eyeL" class="paintable line" x="360" y="145" width="28" height="18" rx="4" fill="#ffffff" />
  <rect id="robot-eyeR" class="paintable line" x="412" y="145" width="28" height="18" rx="4" fill="#ffffff" />
  <rect id="robot-mouth" class="paintable line" x="370" y="180" width="60" height="12" rx="3" fill="#ffffff" />
  <line class="line" x1="400" y1="120" x2="400" y2="100" />
  <circle id="robot-antenna" class="paintable line" cx="400" cy="95" r="8" fill="#ffffff" />
  <!-- cuerpo -->
  <rect id="robot-body" class="paintable line" x="320" y="220" width="160" height="140" rx="12" fill="#ffffff" />
  <rect id="robot-panel1" class="paintable line" x="340" y="240" width="50" height="30" fill="#ffffff" />
  <rect id="robot-panel2" class="paintable line" x="410" y="240" width="50" height="30" fill="#ffffff" />
  <!-- brazos -->
  <rect id="robot-armL" class="paintable line" x="280" y="240" width="40" height="20" rx="6" fill="#ffffff" />
  <rect id="robot-armR" class="paintable line" x="480" y="240" width="40" height="20" rx="6" fill="#ffffff" />
  <!-- piernas -->
  <rect id="robot-legL" class="paintable line" x="350" y="360" width="30" height="60" fill="#ffffff" />
  <rect id="robot-legR" class="paintable line" x="420" y="360" width="30" height="60" fill="#ffffff" />
</svg>
        `,
        castillo: `
<svg id="sheet" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" aria-label="Castillo para colorear">
  <defs>
    <style>
      .line { stroke: #000; stroke-width: 3; }
    </style>
  </defs>
  <!-- base -->
  <rect id="castle-base" class="paintable line" x="200" y="260" width="400" height="160" fill="#ffffff" />
  <!-- torres laterales -->
  <rect id="tower-left" class="paintable line" x="180" y="220" width="80" height="200" fill="#ffffff" />
  <rect id="tower-right" class="paintable line" x="540" y="220" width="80" height="200" fill="#ffffff" />
  <!-- almenas -->
  <rect class="paintable line" x="200" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="230" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="260" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="290" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="320" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="350" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="380" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="410" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="440" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="470" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="500" y="240" width="20" height="20" fill="#ffffff" />
  <rect class="paintable line" x="530" y="240" width="20" height="20" fill="#ffffff" />
  <!-- techos -->
  <polygon id="roof-left" class="paintable line" points="180,220 220,170 260,220" fill="#ffffff" />
  <polygon id="roof-right" class="paintable line" points="540,220 580,170 620,220" fill="#ffffff" />
  <!-- puerta -->
  <rect id="door" class="paintable line" x="380" y="340" width="60" height="80" rx="8" fill="#ffffff" />
  <!-- banderas -->
  <line class="line" x1="220" y1="170" x2="220" y2="150" />
  <polygon id="flag-left" class="paintable line" points="220,150 240,160 220,170" fill="#ffffff" />
  <line class="line" x1="580" y1="170" x2="580" y2="150" />
  <polygon id="flag-right" class="paintable line" points="580,150 600,160 580,170" fill="#ffffff" />
</svg>
        `
      };

      function resetHistory(){ history = []; future = []; }
      function onSheetClick(e){
        const target = e.target;
        if (target && target.classList && target.classList.contains('paintable')) {
          paint(target, currentColor);
        }
      }
      function bindSheet(){
        if (!sheet) return;
        sheet.addEventListener('click', onSheetClick);
      }
      function loadTemplate(key){
        const tpl = templates[key];
        if (!tpl || !board) return;
        board.innerHTML = tpl;
        sheet = document.getElementById('sheet');
        resetHistory();
        bindSheet();
      }

      tplSelect?.addEventListener('change', ()=> loadTemplate(tplSelect.value));

      // Seleccionar color de paleta
      function setActiveColor(color) {
        currentColor = color;
        paletteButtons.forEach(b => b.setAttribute('aria-pressed', String(b.dataset.color === color)));
      }
      paletteButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          setActiveColor(btn.dataset.color);
        });
      });
      setActiveColor(currentColor);

      // Color personalizado
      customColor.addEventListener('input', () => {
        setActiveColor(customColor.value);
      });

      // Borrador
      eraserBtn.addEventListener('click', () => setActiveColor('#ffffff'));

      // Pintar áreas
      function paint(el, color){
        if(!el || !el.classList.contains('paintable')) return;
        const prev = el.getAttribute('fill') || '#ffffff';
        const next = color;
        if (prev === next) return;
        el.setAttribute('fill', next);
        history.push({ type:'paint', id: el.id, prev, next });
        future = [];
      }

      // El manejador de clic se asigna en bindSheet() al cargar una plantilla

      // Deshacer / Rehacer
      function undo(){
        const action = history.pop();
        if(!action) return;
        const el = document.getElementById(action.id);
        if (el) {
          el.setAttribute('fill', action.prev);
          future.push(action);
        }
      }
      function redo(){
        const action = future.pop();
        if(!action) return;
        const el = document.getElementById(action.id);
        if (el) {
          el.setAttribute('fill', action.next);
          history.push(action);
        }
      }
      undoBtn.addEventListener('click', undo);
      redoBtn.addEventListener('click', redo);
      window.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); }
      });

      // Limpiar (blanco todas las zonas pintables)
      function clearAll(){
        const paintables = sheet.querySelectorAll('.paintable');
        paintables.forEach(el => {
          const prev = el.getAttribute('fill') || '#ffffff';
          if (prev !== '#ffffff') {
            el.setAttribute('fill', '#ffffff');
            history.push({ type:'paint', id: el.id, prev, next:'#ffffff' });
          }
        });
        future = [];
      }
      clearBtn.addEventListener('click', clearAll);

      // Guardar como PNG
      function downloadPNG(){
        const svg = document.getElementById('sheet');
        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svg);
        if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
          source = source.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
        }
        if(!source.match(/^<svg[^>]+xmlns\:xlink="http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
          source = source.replace('<svg', '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
        }
        const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);

        const img = new Image();
        const vb = svg.viewBox.baseVal;
        const W = vb && vb.width ? vb.width : svg.clientWidth;
        const H = vb && vb.height ? vb.height : svg.clientHeight;
        const canvas = document.createElement('canvas');
        canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext('2d');
        img.onload = function(){
          ctx.drawImage(img, 0, 0, W, H);
          const png = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = png;
          a.download = 'mi-dibujo.png';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
        img.src = url;
      }
      saveBtn.addEventListener('click', downloadPNG);

      // Cargar plantilla inicial
      if (tplSelect) { tplSelect.value = 'casa'; }
      loadTemplate('casa');
    })();
  </script>
</body>
</html>
